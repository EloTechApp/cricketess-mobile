<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèè Cricketess Mobile - Working Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #1976d2, #e91e63); 
            min-height: 100vh; 
            padding: 20px; 
            color: #333; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 20px; 
            background: linear-gradient(135deg, #e91e63, #1976d2); 
            color: white; 
            border-radius: 10px; 
        }
        .section { 
            margin-bottom: 25px; 
            padding: 20px; 
            border-radius: 10px; 
            background: #f8f9fa; 
        }
        .email-input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 16px; 
            margin-bottom: 15px; 
        }
        .btn { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-bottom: 10px; 
            transition: all 0.3s ease; 
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-camera { background: #4caf50; color: white; }
        .btn-upload { background: #2196f3; color: white; }
        .btn-excel { background: #ff9800; color: white; }
        .preview-img { 
            width: 100%; 
            max-height: 300px; 
            object-fit: contain; 
            border-radius: 8px; 
            margin-bottom: 15px; 
        }
        .status { 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            text-align: center; 
            font-weight: bold; 
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-error { background: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: #f0f0f0; 
            border-radius: 10px; 
            overflow: hidden; 
            margin-bottom: 15px; 
        }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #4caf50, #2196f3); 
            width: 0%; 
            transition: width 0.3s ease; 
        }
        .ocr-text { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
            max-height: 200px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            margin-bottom: 15px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèè Cricketess Mobile</h1>
            <p>Cricket Scorecard OCR - Real Analysis & Excel Export</p>
        </div>

        <!-- Email Input -->
        <div class="section">
            <h3>üìß Email Address (Required)</h3>
            <input type="email" id="emailInput" class="email-input" placeholder="your.email@example.com" required>
        </div>

        <!-- Camera/Upload Section -->
        <div class="section">
            <h3>üì∏ Upload Scorecard Image</h3>
            <button class="btn btn-camera" onclick="takePhoto()">üì∏ Take Photo</button>
            <button class="btn btn-upload" onclick="uploadImage()">üì± Upload from Gallery</button>
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(event)">
            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleFile(event)">
        </div>

        <!-- Status Display -->
        <div id="statusDiv"></div>

        <!-- Progress Bar -->
        <div id="progressSection" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-bottom: 15px;">Starting OCR analysis...</p>
        </div>

        <!-- Image Preview -->
        <div id="previewSection" class="section hidden">
            <h3>üì∑ Captured Image</h3>
            <img id="previewImg" class="preview-img" alt="Scorecard Preview">
        </div>

        <!-- OCR Results -->
        <div id="ocrSection" class="section hidden">
            <h3>üîç OCR Text Extracted</h3>
            <div id="ocrText" class="ocr-text"></div>
            <p><strong>Confidence:</strong> <span id="ocrConfidence">0%</span></p>
        </div>

        <!-- Excel Export -->
        <div id="excelSection" class="section hidden">
            <h3>üìä Export to Excel</h3>
            <button class="btn btn-excel" onclick="exportToExcel()">üìä Generate & Download Excel Report</button>
        </div>
    </div>

    <script>
        let capturedImageData = null;
        let ocrResult = null;
        let extractedCricketData = null;

        // Take photo function
        function takePhoto() {
            if (!validateEmail()) return;
            
            console.log('Taking photo...');
            document.getElementById('cameraInput').click();
        }

        // Upload image function
        function uploadImage() {
            if (!validateEmail()) return;
            
            console.log('Uploading image...');
            document.getElementById('fileInput').click();
        }

        // Validate email
        function validateEmail() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email || !email.includes('@')) {
                showStatus('Please enter a valid email address first!', 'error');
                return false;
            }
            return true;
        }

        // Handle file selection
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name, file.type, file.size);

            if (!file.type.startsWith('image/')) {
                showStatus('Please select an image file!', 'error');
                return;
            }

            showStatus('Image selected! Processing...', 'processing');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                capturedImageData = e.target.result;
                showPreview(capturedImageData);
                startOCRAnalysis(capturedImageData);
            };
            reader.readAsDataURL(file);
        }

        // Show image preview
        function showPreview(imageData) {
            document.getElementById('previewImg').src = imageData;
            document.getElementById('previewSection').classList.remove('hidden');
        }

        // Start OCR analysis
        async function startOCRAnalysis(imageData) {
            try {
                showStatus('Starting OCR analysis...', 'processing');
                showProgress(0, 'Initializing Tesseract OCR...');
                
                const result = await Tesseract.recognize(
                    imageData,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                showProgress(progress, `OCR Analysis: ${progress}% complete`);
                            }
                        }
                    }
                );

                ocrResult = result.data;
                showOCRResults(ocrResult);
                extractCricketData(ocrResult);
                
            } catch (error) {
                console.error('OCR Error:', error);
                showStatus('OCR analysis failed. Please try again.', 'error');
            }
        }

        // Show progress
        function showProgress(percent, text) {
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
            
            if (percent >= 100) {
                setTimeout(() => {
                    document.getElementById('progressSection').classList.add('hidden');
                }, 2000);
            }
        }

        // Show OCR results
        function showOCRResults(result) {
            document.getElementById('ocrText').textContent = result.text || 'No text detected';
            document.getElementById('ocrConfidence').textContent = (result.confidence || 0).toFixed(1) + '%';
            document.getElementById('ocrSection').classList.remove('hidden');
            
            showStatus(`OCR completed! Confidence: ${(result.confidence || 0).toFixed(1)}%`, 'success');
        }

        // Extract cricket data from OCR text
        function extractCricketData(ocrResult) {
            const text = ocrResult.text || '';
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            
            console.log('Extracting cricket data from:', lines);
            
            // Basic cricket data extraction
            let teamA = 'Team A';
            let teamB = 'Team B';
            let venue = 'Cricket Ground';
            let date = new Date().toLocaleDateString();
            
            // Look for team names
            for (const line of lines) {
                if (line.toLowerCase().includes('vs') || line.toLowerCase().includes('v ')) {
                    const teams = line.split(/vs|v /i);
                    if (teams.length >= 2) {
                        teamA = teams[0].trim();
                        teamB = teams[1].trim();
                    }
                }
            }
            
            // Extract player data
            const players = [];
            const bowlers = [];
            
            for (const line of lines) {
                const numbers = line.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    const name = line.replace(/\d+/g, '').replace(/[^\w\s]/g, '').trim();
                    if (name.length > 2) {
                        if (line.toLowerCase().includes('bowl')) {
                            bowlers.push({
                                name: name,
                                overs: parseFloat(numbers[0]) || 0,
                                runs: parseInt(numbers[1]) || 0,
                                wickets: parseInt(numbers[2]) || 0
                            });
                        } else {
                            players.push({
                                name: name,
                                runs: parseInt(numbers[0]) || 0,
                                balls: parseInt(numbers[1]) || 0,
                                fours: parseInt(numbers[2]) || 0,
                                sixes: parseInt(numbers[3]) || 0
                            });
                        }
                    }
                }
            }
            
            extractedCricketData = {
                matchInfo: {
                    teamA: teamA,
                    teamB: teamB,
                    date: date,
                    venue: venue,
                    ocrConfidence: ocrResult.confidence || 0,
                    textLength: text.length,
                    linesDetected: lines.length
                },
                players: players.length > 0 ? players : [
                    {name: 'Player 1', runs: 0, balls: 0, fours: 0, sixes: 0},
                    {name: 'Player 2', runs: 0, balls: 0, fours: 0, sixes: 0}
                ],
                bowlers: bowlers.length > 0 ? bowlers : [
                    {name: 'Bowler 1', overs: 0, runs: 0, wickets: 0},
                    {name: 'Bowler 2', overs: 0, runs: 0, wickets: 0}
                ]
            };
            
            console.log('Extracted cricket data:', extractedCricketData);
            
            // Show Excel export option
            document.getElementById('excelSection').classList.remove('hidden');
            showStatus('Cricket data extracted! Ready to export to Excel.', 'success');
        }

        // Export to Excel
        function exportToExcel() {
            if (!extractedCricketData) {
                showStatus('No cricket data to export!', 'error');
                return;
            }
            
            showStatus('Generating Excel file...', 'processing');
            
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: Match Summary
            const matchData = [
                ['CRICKETESS MOBILE - CRICKET SCORECARD ANALYSIS'],
                [''],
                ['Match Information'],
                ['Team A', extractedCricketData.matchInfo.teamA],
                ['Team B', extractedCricketData.matchInfo.teamB],
                ['Date', extractedCricketData.matchInfo.date],
                ['Venue', extractedCricketData.matchInfo.venue],
                [''],
                ['OCR Analysis Results'],
                ['OCR Confidence', extractedCricketData.matchInfo.ocrConfidence.toFixed(1) + '%'],
                ['Text Length', extractedCricketData.matchInfo.textLength],
                ['Lines Detected', extractedCricketData.matchInfo.linesDetected],
                ['Processing Method', 'Tesseract OCR'],
                ['Generated', new Date().toLocaleString()],
                ['Email', document.getElementById('emailInput').value]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(matchData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Match Summary');
            
            // Sheet 2: Batting Statistics
            const battingData = [
                ['BATTING STATISTICS'],
                [''],
                ['Player', 'Runs', 'Balls', 'Fours', 'Sixes', 'Strike Rate'],
                ...extractedCricketData.players.map(p => [
                    p.name, 
                    p.runs, 
                    p.balls, 
                    p.fours, 
                    p.sixes, 
                    p.balls > 0 ? ((p.runs / p.balls) * 100).toFixed(2) : 0
                ])
            ];
            
            const ws2 = XLSX.utils.aoa_to_sheet(battingData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Batting Stats');
            
            // Sheet 3: Bowling Statistics
            const bowlingData = [
                ['BOWLING STATISTICS'],
                [''],
                ['Bowler', 'Overs', 'Runs', 'Wickets', 'Economy'],
                ...extractedCricketData.bowlers.map(b => [
                    b.name, 
                    b.overs, 
                    b.runs, 
                    b.wickets, 
                    b.overs > 0 ? (b.runs / b.overs).toFixed(2) : 0
                ])
            ];
            
            const ws3 = XLSX.utils.aoa_to_sheet(bowlingData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Bowling Stats');
            
            // Sheet 4: Raw OCR Data
            const ocrData = [
                ['RAW OCR TEXT DATA'],
                [''],
                ['Confidence Level', (ocrResult.confidence || 0).toFixed(1) + '%'],
                ['Processing Time', new Date().toLocaleString()],
                [''],
                ['Extracted Text'],
                [ocrResult.text || 'No text detected']
            ];
            
            const ws4 = XLSX.utils.aoa_to_sheet(ocrData);
            XLSX.utils.book_append_sheet(wb, ws4, 'OCR Data');
            
            // Generate filename
            const fileName = `Cricketess_${extractedCricketData.matchInfo.teamA.replace(/\s+/g, '')}_vs_${extractedCricketData.matchInfo.teamB.replace(/\s+/g, '')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // Download the file
            XLSX.writeFile(wb, fileName);
            
            showStatus(`Excel file "${fileName}" downloaded successfully!`, 'success');
            
            // Offer to email the file
            setTimeout(() => {
                if (confirm('Excel file downloaded! Would you like to email it?')) {
                    emailExcelFile(fileName);
                }
            }, 2000);
        }

        // Email Excel file
        function emailExcelFile(fileName) {
            const email = document.getElementById('emailInput').value;
            const subject = encodeURIComponent('Cricket Scorecard Analysis - ' + fileName);
            const body = encodeURIComponent(`Cricket scorecard analysis completed!

Match: ${extractedCricketData.matchInfo.teamA} vs ${extractedCricketData.matchInfo.teamB}
Date: ${extractedCricketData.matchInfo.date}
OCR Confidence: ${extractedCricketData.matchInfo.ocrConfidence.toFixed(1)}%

The Excel file "${fileName}" has been generated with:
- Match summary
- Batting statistics  
- Bowling statistics
- Raw OCR data

Please attach the downloaded Excel file to this email.

Generated by Cricketess Mobile - Real Cricket OCR Analysis`);

            const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');
            
            showStatus('Email client opened! Please attach the Excel file.', 'success');
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status status-${type}">${message}</div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Cricketess Mobile initialized');
            
            // Load saved email
            const savedEmail = localStorage.getItem('cricketessEmail');
            if (savedEmail) {
                document.getElementById('emailInput').value = savedEmail;
            }
            
            // Save email on input
            document.getElementById('emailInput').addEventListener('input', function() {
                localStorage.setItem('cricketessEmail', this.value);
            });
        });
    </script>
</body>
</html>
